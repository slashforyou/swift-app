name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ==========================================
  # Job 1: Tests & Coverage
  # ==========================================
  test:
    name: ðŸ§ª Tests & Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ” Run TypeScript compiler check
        run: npx tsc --noEmit
      
      - name: ðŸ§ª Run all tests
        run: npm test -- --coverage --maxWorkers=2
      
      - name: ðŸ“Š Generate coverage report
        if: matrix.node-version == '20.x'
        run: |
          echo "Coverage Summary:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.txt >> $GITHUB_STEP_SUMMARY || echo "No coverage summary available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“ˆ Upload coverage to Codecov
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: swift-app-coverage
          fail_ci_if_error: false
      
      - name: ðŸ’¾ Upload coverage artifacts
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # ==========================================
  # Job 2: Linting & Code Quality
  # ==========================================
  lint:
    name: ðŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ” Run ESLint
        run: npm run lint --if-present || echo "âš ï¸ No lint script found"
        continue-on-error: true
      
      - name: ðŸ“ Check formatting (Prettier)
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx}" || echo "âš ï¸ Prettier check skipped"
        continue-on-error: true

  # ==========================================
  # Job 3: Build Validation
  # ==========================================
  build:
    name: ðŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build TypeScript
        run: npx tsc --noEmit
      
      - name: ðŸ“± Check Expo compatibility
        run: |
          echo "âœ… Checking Expo project structure..."
          test -f app.json && echo "âœ… app.json exists" || echo "âŒ app.json missing"
          test -f package.json && echo "âœ… package.json exists" || echo "âŒ package.json missing"
      
      - name: ðŸ“Š Build summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Project structure validated" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 4: Security Audit
  # ==========================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ”’ Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true
      
      - name: ðŸ“Š Security summary
        run: |
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Some vulnerabilities found" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Job 5: Test Results Summary
  # ==========================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [test, lint, build, security]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
